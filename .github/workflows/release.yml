name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: sockets
          tools: composer:v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader

      - name: Run code quality checks
        run: |
          composer install --prefer-dist --no-progress --no-interaction
          composer cs-check || test $? -eq 1
          composer analyse || true
          composer test

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: sockets
          tools: composer:v2

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction --no-dev --optimize-autoloader

      - name: Create release archive
        run: |
          mkdir -p build
          rsync -av --exclude='.git' \
                    --exclude='.github' \
                    --exclude='.gitignore' \
                    --exclude='.phpunit.cache' \
                    --exclude='.phpstan.cache' \
                    --exclude='tests' \
                    --exclude='demo-projects' \
                    --exclude='examples' \
                    --exclude='tools' \
                    --exclude='phpunit.xml.dist' \
                    --exclude='phpstan.neon' \
                    --exclude='devenv.*' \
                    --exclude='.devenv*' \
                    --exclude='.direnv' \
                    --exclude='.envrc' \
                    --exclude='podman-compose.yml' \
                    --exclude='*.sh' \
                    --exclude='IMPLEMENTATION_PLAN.md' \
                    --exclude='PROGRESS.md' \
                    --exclude='.idea' \
                    --exclude='build' \
                    ./ php-opcua/
          cd php-opcua && zip -r ../build/php-opcua-${GITHUB_REF_NAME}.zip . && cd ..
          tar -czf build/php-opcua-${GITHUB_REF_NAME}.tar.gz php-opcua/

      - name: Generate changelog
        id: changelog
        run: |
          # Extract version from tag
          VERSION=${GITHUB_REF_NAME}
          
          # Get the previous tag
          PREVIOUS_TAG=$(git tag --sort=-v:refname | grep -A1 "${GITHUB_REF_NAME}" | tail -n1)
          
          # Generate changelog
          if [ -n "$PREVIOUS_TAG" ] && [ "$PREVIOUS_TAG" != "${GITHUB_REF_NAME}" ]; then
            CHANGELOG=$(git log ${PREVIOUS_TAG}..${GITHUB_REF_NAME} --pretty=format:"- %s (%h)" --no-merges)
          else
            CHANGELOG=$(git log ${GITHUB_REF_NAME} --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save to file for the release
          cat > release_notes.md << EOF
          ## Release ${VERSION}
          
          ### Changes
          ${CHANGELOG}
          
          ### Installation
          
          \`\`\`bash
          composer require techdock/opcua:${VERSION}
          \`\`\`
          
          Or download the release archive and include it in your project.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release_notes.md
          files: |
            build/php-opcua-*.zip
            build/php-opcua-*.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
